services:
  frontend:
    build:
      context: ../apps/frontend
    env_file:
      - ../.env
    environment:
      - API_BASE_URL=http://backend:8000
      - NEXT_PUBLIC_API_BASE_URL=https://${APP_DOMAIN}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    depends_on:
      - backend

  backend:
    build:
      context: ../services/backend
    env_file:
      - ../.env
    environment:
      - DATABASE_URL=postgresql+psycopg://postgres:postgres@postgres:5432/mh
      - MCP_BASE_URL=http://mcp:7000
      - FRONTEND_URL=https://${APP_DOMAIN}
      - GOOGLE_REDIRECT_URI=https://${APP_DOMAIN}/auth/google/callback
      - COOKIE_SECURE=true
      - COOKIE_SAMESITE=lax
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_PRICE_ID=${STRIPE_PRICE_ID}
    depends_on:
      - postgres
      - mcp

  mcp:
    build:
      context: ../services/mcp
    env_file:
      - ../.env
    environment:
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}

  ollama:
    image: ollama/ollama:latest
    volumes:
      - ollama:/root/.ollama

  postgres:
    image: pgvector/pgvector:pg16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=mh
    volumes:
      - pgdata:/var/lib/postgresql/data

  proxy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../Caddyfile.oracle:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - backend

volumes:
  pgdata:
  ollama:
  caddy_data:
  caddy_config:
